<!doctype html>
<html lang="{{ html_lang }}" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÁÆ°ÁêÜËÄÖÂ†±Ë°®</title>
  <style>
    :root {
      --bg-page: #f6f8fa;
      --text-main: #1f2328;
      --text-subtle: #57606a;
      --bg-surface: #ffffff;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.08);
      --border-soft: #d8dee4;
      --bg-subtle: #f6f8fa;
      --bg-meta: #eef6ff;
      --border-meta: #cce1ff;
      --bg-tag: #eef6ff;
      --border-tag: #cce1ff;
      --theme-light: #9ec5ff;
      --theme-forest: #3d7a5f;
      --theme-dark: #394553;
    }
    html[data-theme="forest"] {
      --bg-page: #eaf3ee;
      --text-main: #17241f;
      --text-subtle: #355246;
      --bg-surface: #f7fbf8;
      --shadow-soft: 0 2px 10px rgba(23,36,31,0.10);
      --border-soft: #b9cec2;
      --bg-subtle: #edf5ef;
      --bg-meta: #e6f2eb;
      --border-meta: #bad5c6;
      --bg-tag: #e6f2eb;
      --border-tag: #bad5c6;
      --theme-light: #9ec5ff;
      --theme-forest: #3d7a5f;
      --theme-dark: #394553;
    }
    html[data-theme="dark"] {
      --bg-page: #11161c;
      --text-main: #e6edf3;
      --text-subtle: #a8b3bf;
      --bg-surface: #1a2129;
      --shadow-soft: 0 2px 12px rgba(0,0,0,0.45);
      --border-soft: #34404d;
      --bg-subtle: #1f2a35;
      --bg-meta: #253545;
      --border-meta: #4a6680;
      --bg-tag: #253545;
      --border-tag: #3f5870;
      --theme-light: #a2c5ff;
      --theme-forest: #6db192;
      --theme-dark: #b9c4d0;
    }
    body {
      margin: 0;
      background: var(--bg-page);
      font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
      color: var(--text-main);
    }
    .wrap {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 16px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }
    .header h1 {
      margin: 0;
      font-size: 26px;
      line-height: 1.35;
    }
    .title-block { flex: 1 1 auto; min-width: 0; }
    .title-block h1 { word-break: break-word; }
    .control-panel { display: inline-flex; flex-direction: column; align-items: flex-end; gap: 8px; }
    .lang-switch { display: inline-flex; gap: 6px; }
    .lang-btn {
      text-decoration: none;
      color: var(--text-main);
      border: 1px solid var(--border-soft);
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 13px;
      background: var(--bg-surface);
    }
    .lang-btn.active { font-weight: 600; background: var(--bg-subtle); }
    .theme-switch { display: inline-flex; gap: 6px; }
    .theme-btn {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: var(--bg-surface);
      color: var(--text-main);
      font-weight: 700;
      font-size: 13px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .theme-btn.active {
      box-shadow: 0 0 0 2px var(--bg-surface), 0 0 0 4px var(--border-soft);
    }
    .theme-btn[data-theme-option="light"] { color: var(--theme-light); }
    .theme-btn[data-theme-option="forest"] { color: var(--theme-forest); }
    .theme-btn[data-theme-option="dark"] { color: var(--theme-dark); }
    .export-btn {
      text-decoration: none;
      background: #3f8b56;
      color: #fff;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      border: 0;
      cursor: pointer;
    }
    .export-btn:hover { background: #327046; }
    .pdf-btn {
      background: #c98980;
    }
    .pdf-btn:hover {
      background: #b4766d;
    }
    .report-actions {
      display: flex;
      justify-content: flex-end;
      margin: -4px 0 16px;
    }
    .toolbar { display: inline-flex; gap: 8px; align-items: center; }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .summary-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      padding: 12px;
    }
    .summary-title { color: var(--text-subtle); font-size: 13px; margin-bottom: 6px; }
    .summary-value { font-size: 24px; font-weight: 700; }

    .filter-bar {
      background: var(--bg-surface);
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .filter-form {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .filter-selected {
      margin-top: 8px;
      color: var(--text-subtle);
      font-size: 13px;
      font-weight: 600;
    }
    .filter-label {
      color: var(--text-subtle);
      font-weight: 600;
      font-size: 14px;
    }
    .date-input {
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      background: var(--bg-surface);
      color: var(--text-main);
      padding: 7px 10px;
      font-size: 14px;
      min-width: 220px;
    }
    .filter-btn {
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      background: var(--bg-subtle);
      color: var(--text-main);
      padding: 7px 12px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
    }
    .filter-btn:hover {
      background: var(--bg-page);
    }

    .panel-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-subtle);
      border-bottom: 1px solid var(--border-soft);
    }
    .panel-title {
      margin: 0;
      font-size: 15px;
      font-weight: 700;
      color: var(--text-main);
    }
    .collapse-toggle {
      border: 1px solid var(--border-soft);
      border-radius: 6px;
      background: var(--bg-surface);
      color: var(--text-main);
      width: 28px;
      height: 28px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }
    .collapse-toggle:hover {
      background: var(--bg-page);
    }
    .panel-body {
      padding: 10px;
    }
    .panel-body[hidden] {
      display: none;
    }

    .record-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .record-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      padding: 10px;
      transition: border-color .12s ease, box-shadow .12s ease, background .12s ease;
      width: fit-content;
      max-width: 100%;
      min-width: 180px;
    }
    .record-card.active {
      border-color: var(--border-meta);
      background: var(--bg-meta);
      box-shadow: var(--shadow-soft);
    }
    .record-select {
      width: 100%;
      border: 0;
      background: transparent;
      cursor: pointer;
      text-align: left;
      padding: 0;
      display: grid;
      gap: 6px;
    }
    .record-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .record-detail { display: grid; gap: 10px; }
    .record-tools {
      display: flex;
      justify-content: flex-end;
    }
    .delete-one-btn {
      background: var(--bg-subtle);
      color: var(--text-subtle);
      border: 1px solid var(--border-soft);
      border-radius: 6px;
      width: 24px;
      height: 24px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      line-height: 1;
    }
    .delete-one-btn:hover {
      background: var(--bg-page);
      color: var(--text-main);
    }
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .detail-panel {
      display: grid;
      gap: 10px;
      margin-bottom: 12px;
    }
    .detail-panel-header {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
    }
    .detail-panel-hint {
      margin: 0;
      color: var(--text-subtle);
      font-size: 14px;
    }
    .detail-section {
      background: var(--bg-surface);
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      padding: 10px;
      display: grid;
      gap: 8px;
    }
    .basic-detail-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      overflow: hidden;
      background: var(--bg-surface);
    }
    .basic-detail-table th,
    .basic-detail-table td {
      border-left: 1px solid var(--border-soft);
      padding: 8px 10px;
      vertical-align: top;
      text-align: left;
    }
    .basic-detail-table th:first-child,
    .basic-detail-table td:first-child {
      border-left: 0;
    }
    .basic-detail-table .table-label {
      background: var(--bg-subtle);
      color: var(--text-subtle);
      font-size: 13px;
      font-weight: 700;
      border-bottom: 1px solid var(--border-soft);
    }
    .basic-detail-table .table-detail {
      background: var(--bg-surface);
    }
    .detail-title {
      margin: 0;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-main);
      display: inline-flex;
      align-items: center;
      border-radius: 8px;
      padding: 6px 10px;
      border: 1px solid var(--border-soft);
      background: var(--bg-subtle);
    }
    .detail-title-basic {
      background: var(--bg-meta);
      border-color: var(--border-meta);
    }
    .detail-title-questionnaire {
      background: var(--bg-tag);
      border-color: var(--border-tag);
    }
    .detail-items {
      display: grid;
      gap: 6px;
    }
    .detail-item {
      display: grid;
      gap: 4px;
    }
    .detail-label {
      font-size: 13px;
      color: var(--text-subtle);
      font-weight: 600;
    }
    .detail-value {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .mini-chip {
      display: inline-flex;
      align-items: center;
      background: var(--bg-tag);
      border: 1px solid var(--border-tag);
      border-radius: 999px;
      padding: 5px 10px;
      font-size: 13px;
      line-height: 1.25;
      font-weight: 600;
    }
    .empty {
      background: var(--bg-surface);
      border: 1px dashed var(--border-soft);
      border-radius: 10px;
      padding: 18px;
      color: var(--text-subtle);
    }
    .page-footer {
      margin-top: 18px;
    }
    .page-footer-card {
      background: var(--bg-meta);
      border: 1px solid var(--border-meta);
      border-radius: 10px;
      box-shadow: var(--shadow-soft);
      padding: 14px 12px 12px;
      max-width: 880px;
      margin: 0 auto;
      text-align: center;
      color: var(--text-main);
      display: grid;
      gap: 4px;
      line-height: 1.5;
    }
    .page-footer-line {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.1px;
    }
    .page-footer-line:first-child {
      font-size: 16px;
      font-weight: 700;
    }

    @media (max-width: 900px) {
      .summary-grid { grid-template-columns: 1fr; }
      .header { flex-direction: column; align-items: stretch; }
      .control-panel { align-items: flex-end; }
      .record-grid { display: grid; grid-template-columns: 1fr; }
      .date-input { min-width: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title-block">
        <h1>{{ admin_ui.page_title }}ÔΩú{{ survey_title }}</h1>
      </div>
      <div class="control-panel">
        <div class="lang-switch">
          <a class="lang-btn {% if current_lang == 'zh-TW' %}active{% endif %}" href="{{ lang_urls['zh-TW'] }}">{{ admin_ui.lang_zh }}</a>
          <a class="lang-btn {% if current_lang == 'en' %}active{% endif %}" href="{{ lang_urls['en'] }}">{{ admin_ui.lang_en }}</a>
        </div>
        <div class="theme-switch" aria-label="theme switcher">
          <button class="theme-btn" type="button" data-theme-option="light" aria-label="light theme">O</button>
          <button class="theme-btn" type="button" data-theme-option="forest" aria-label="forest theme">O</button>
          <button class="theme-btn" type="button" data-theme-option="dark" aria-label="dark theme">O</button>
        </div>
      </div>
    </div>

    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-title">{{ admin_ui.total_submissions }}</div>
        <div class="summary-value">{{ summary.total_submissions }}</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">{{ admin_ui.department_count }}</div>
        <div class="summary-value">{{ summary.department_count }}</div>
      </div>
      <div class="summary-card">
        <div class="summary-title">{{ admin_ui.latest_submitted_at }}</div>
        <div class="summary-value" style="font-size: 18px;">{{ summary.latest_submitted_at }}</div>
      </div>
    </div>
    <div class="report-actions">
      <div class="toolbar">
        <a class="export-btn" href="{{ export_url }}">CSV</a>
        <a class="export-btn pdf-btn" href="{{ export_pdf_url }}">PDF</a>
      </div>
    </div>

    <div class="filter-bar">
      <form class="filter-form" method="get" action="{{ url_for('admin_report') }}">
        <input type="hidden" name="lang" value="{{ current_lang }}">
        <label class="filter-label" for="date-filter">{{ admin_ui.filter_date_label }}</label>
        <input class="date-input" id="date-filter" name="date" type="date" value="{{ selected_date }}">
        <button type="submit" class="filter-btn">{{ admin_ui.filter_apply }}</button>
        <a class="filter-btn" href="{{ url_for('admin_report', lang=current_lang) }}">{{ admin_ui.filter_reset }}</a>
      </form>
      {% if selected_date_display %}
      <div class="filter-selected">{{ admin_ui.filter_selected_date }}: {{ selected_date_display }}</div>
      {% endif %}
    </div>

    {% if records %}
      <section class="panel-card">
        <div class="panel-header">
          <h2 class="panel-title">{{ admin_ui.compact_panel_title }}</h2>
          <button class="collapse-toggle" type="button" data-collapse-target="compact-list-body" aria-expanded="true" aria-label="{{ admin_ui.compact_panel_toggle }}">‚ñæ</button>
        </div>
        <div class="panel-body" id="compact-list-body">
          <div class="record-grid">
          {% for record in records %}
            <article class="record-card" data-record-id="{{ record.id }}">
              <button class="record-select" type="button" data-record-select="{{ record.id }}" aria-label="open details">
                <div class="record-row">
                  <span class="mini-chip">{{ record.submitted_time }}</span>
                  <span class="mini-chip">{{ record.department_name }}</span>
                  <span class="mini-chip">{{ record.person_name }}</span>
                </div>
              </button>
            </article>

            <template id="record-detail-template-{{ record.id }}">
              <div class="record-detail">
                <div class="record-tools">
                  <form method="post" action="{{ url_for('admin_report_delete_one', record_id=record.id) }}" data-department="{{ record.department_name }}" data-person="{{ record.person_name }}" onsubmit="return confirmDeleteRecord(this);">
                    <button type="submit" class="delete-one-btn" aria-label="{{ admin_ui.delete_aria }}" title="{{ admin_ui.delete_aria }}">üóë</button>
                  </form>
                </div>
                <div class="detail-grid">
                  <section class="detail-section">
                    <h3 class="detail-title detail-title-basic">{{ admin_ui.basic_section }}</h3>
                    <table class="basic-detail-table" role="table">
                      <thead>
                        <tr>
                          {% for item in record.basic_items %}
                          <th class="table-label" scope="col">{{ item.label }}</th>
                          {% endfor %}
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          {% for item in record.basic_items %}
                          <td class="table-detail">
                            <div class="detail-value">
                          {% for chip in item.chips %}
                          <span class="mini-chip">{{ chip }}</span>
                          {% endfor %}
                            </div>
                          </td>
                          {% endfor %}
                        </tr>
                      </tbody>
                    </table>
                  </section>
                  <section class="detail-section">
                    <h3 class="detail-title detail-title-questionnaire">{{ admin_ui.questionnaire_section }}</h3>
                    <div class="detail-items">
                      {% for item in record.questionnaire_items %}
                      <div class="detail-item">
                        <div class="detail-label">{{ item.label }}</div>
                        <div class="detail-value">
                          {% for chip in item.chips %}
                          <span class="mini-chip">{{ chip }}</span>
                          {% endfor %}
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </section>
                </div>
              </div>
            </template>
          {% endfor %}
          </div>
        </div>
      </section>

      <section class="panel-card detail-panel" id="detail-panel">
        <div class="panel-header">
          <h2 class="panel-title">{{ admin_ui.detail_panel_title }}</h2>
          <button class="collapse-toggle" type="button" data-collapse-target="detail-panel-body" aria-expanded="true" aria-label="{{ admin_ui.detail_panel_toggle }}">‚ñæ</button>
        </div>
        <div class="panel-body" id="detail-panel-body">
          <p class="detail-panel-hint" id="detail-panel-hint">{{ admin_ui.detail_panel_hint }}</p>
          <div id="detail-panel-content"></div>
        </div>
      </section>
    {% else %}
      <div class="empty">{{ admin_ui.filter_no_match if selected_date else admin_ui.empty_text }}</div>
    {% endif %}

    <div class="page-footer" aria-label="page footer">
      <div class="page-footer-card">
        <div class="page-footer-line">{{ admin_ui.footer_provider }}</div>
        <div class="page-footer-line">{{ admin_ui.footer_contact }}</div>
      </div>
    </div>
  </div>

<script>
  function applyTheme(themeName) {
    const validThemes = ['light', 'forest', 'dark'];
    const resolvedTheme = validThemes.includes(themeName) ? themeName : 'light';
    document.documentElement.setAttribute('data-theme', resolvedTheme);
    localStorage.setItem('survey-theme', resolvedTheme);

    document.querySelectorAll('[data-theme-option]').forEach((button) => {
      button.classList.toggle('active', button.dataset.themeOption === resolvedTheme);
    });
  }

  const savedTheme = localStorage.getItem('survey-theme') || 'light';
  applyTheme(savedTheme);

  document.querySelectorAll('[data-theme-option]').forEach((button) => {
    button.addEventListener('click', () => applyTheme(button.dataset.themeOption));
  });

  const deleteConfirmTemplate = {{ admin_ui.delete_confirm_template | tojson }};
  const unknownText = {{ admin_ui.unknown_text | tojson }};

  function confirmDeleteRecord(formElement) {
    const department = formElement.dataset.department || unknownText;
    const person = formElement.dataset.person || unknownText;
    const message = deleteConfirmTemplate
      .replace('{department}', department)
      .replace('{person}', person);
    return window.confirm(message);
  }

  function renderRecordDetail(recordId) {
    const panelBody = document.getElementById('detail-panel-content');
    const panelHint = document.getElementById('detail-panel-hint');
    if (!panelBody || !panelHint) {
      return;
    }

    const template = document.getElementById(`record-detail-template-${recordId}`);
    if (!template) {
      return;
    }

    panelBody.innerHTML = '';
    panelBody.appendChild(template.content.cloneNode(true));
    panelHint.hidden = true;

    document.querySelectorAll('.record-card').forEach((card) => {
      card.classList.toggle('active', card.dataset.recordId === String(recordId));
    });
  }

  document.querySelectorAll('[data-record-select]').forEach((button) => {
    button.addEventListener('click', () => renderRecordDetail(button.dataset.recordSelect));
  });

  document.querySelectorAll('[data-collapse-target]').forEach((button) => {
    button.addEventListener('click', () => {
      const targetId = button.dataset.collapseTarget;
      const target = document.getElementById(targetId);
      if (!target) {
        return;
      }
      const expanded = button.getAttribute('aria-expanded') === 'true';
      const next = !expanded;
      button.setAttribute('aria-expanded', String(next));
      target.hidden = !next;
      button.textContent = next ? '‚ñæ' : '‚ñ∏';
    });
  });
</script>
</body>
</html>
